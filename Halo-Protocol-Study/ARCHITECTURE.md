# Halo: The Economic OS Gateway for Agentic Commerce ğŸ¥§

**Bridging the Trillion-Dollar Agent Economy to Circle's Arc Blockchain**

## ğŸ—ï¸ System Architecture: Universal Orchestration to Arc Settlement

Halo is the infrastructure layer designed to capture the multi-trillion dollar agentic commerce industry. It serves as the primary gateway for Circle's **Arc (The Economic OS)**, mapping fragmented agent protocols to unified, verifiable state transitions on the **Arc Circles chain**.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AGENT PROTOCOL LAYER (ACP | UCP | x402)            â”‚
â”‚       The Trillion Dollar Entry Point for Agent Intents         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚  Protocol-Agnostic Intent Delivery
                     â”‚  (Natural Language | Structured JSON)
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               HALO AGENTIC ORCHESTRATION LAYER                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Universal Protocol Router                               â”‚   â”‚
â”‚  â”‚  â€¢ Detects Agent Protocol (ACP/UCP/x402)                 â”‚   â”‚
â”‚  â”‚  â€¢ Translates Intent to Canonical Economic Model        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                               â”‚
â”‚                 â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Economic State Registry (Intent Ledger)                 â”‚   â”‚
â”‚  â”‚  â€¢ SHA-256 Chaining of Agent Decisions                  â”‚   â”‚
â”‚  â”‚  â€¢ Verifiable Intent Audit Trail for Arc Blockchain      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚     â–¼           â–¼           â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Risk    â”‚ â”‚Negotiatorâ”‚ â”‚State      â”‚                       â”‚
â”‚  â”‚ Engine  â”‚ â”‚Capabilityâ”‚ â”‚Normalizer â”‚                       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚  â”‚0-100 Arcâ”‚ â”‚Bridge    â”‚ â”‚Map to Arc â”‚                       â”‚
â”‚  â”‚RiskScoreâ”‚ â”‚Merchant  â”‚ â”‚Transitionsâ”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚       â”‚           â”‚             â”‚                               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                   â–¼                                               â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚           â”‚ Arc Settlement   â”‚                                  â”‚
â”‚           â”‚ Decision Logic   â”‚                                  â”‚
â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                  â”‚
â”‚           â”‚ Score < 30?      â”‚                                  â”‚
â”‚           â”‚ â†’ SETTLE ON ARC  â”‚                                  â”‚
â”‚           â”‚                  â”‚                                  â”‚
â”‚           â”‚ 30 â‰¤ Score â‰¤ 60? â”‚                                  â”‚
â”‚           â”‚ â†’ WALLET SIG     â”‚                                  â”‚
â”‚           â”‚                  â”‚                                  â”‚
â”‚           â”‚ Score > 60?      â”‚                                  â”‚
â”‚           â”‚ â†’ BLOCK INTENT   â”‚                                  â”‚
â”‚           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                â”‚                                                â”‚
â”‚                â”œâ”€â”€â–º Decision == "settle"?                       â”‚
â”‚                â”‚         â”‚                                      â”‚
â”‚                â”‚    Yes  â–¼                                      â”‚
â”‚                â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                â”‚    â”‚ Circle Arc Svc   â”‚                       â”‚
â”‚                â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚                â”‚    â”‚USDC Economic OS  â”‚                       â”‚
â”‚                â”‚    â”‚State Transition  â”‚                       â”‚
â”‚                â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                â”‚                                                â”‚
â”‚                â–¼                                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ Economic Response Builder (Arc Protocol)              â”‚    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚    â”‚ {                                                    â”‚    â”‚
â”‚    â”‚   arc_transition_id: string,                         â”‚    â”‚
â”‚    â”‚   settlement: "settled" | "pending" | "blocked",     â”‚    â”‚
â”‚    â”‚   intent_hash: string (Registry Reference)           â”‚    â”‚
â”‚    â”‚ }                                                    â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Economic OS Response (Internet of Value)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Economic Data Flow

### Step 1: Fragmented Protocol Intake
Halo accepts any trillion-dollar agent intent, whether it arrives via the Agentic Checkout Protocol (ACP), Universal Commerce Protocol (UCP), or HTTP 402.

### Step 2: Canonical Intent Translation
The `ProtocolRouter` strips protocol-specific noise, translating the request into a **Canonical Economic Intent**.

### Step 3: Immutable Registry Chaining
Before settlement, every intent and risk decision is recorded in the **Economic State Registry** using SHA-256 block-chaining. This ensures that the agent's commercial history is verifiable on the Arc blockchain.

### Step 4: Arc-Native Risk Evaluation
The Risk Engine applies Arc-specific scoring rules. Low-risk intents are routed for instant settlement. Medium-risk intents trigger an **Arc Wallet Signature Challenge**.

### Step 5: Circle USDC Settlement
Halo executes the final settlement via Circle's **Arc Economic OS**, utilizing USDC as the universal value carrier and CCTP for cross-chain liquidity.

### Step 6: Return Response
```
{
  "risk_score": 40,
  "decision": "challenge",
  "normalized_payload": {
    "halo_normalized": {
      "total_cents": 8300,
      "currency": "usd",
      "country": "US",
      "provider": "stripe",
      "shipping_speed": "express"
    }
  }
}
```

---

## ğŸ”„ Risk Scoring Examples

### Example 1: Low Risk â†’ APPROVE
```
Input: $20 purchase, US, standard shipping
Scoring:
  - Amount > $50? NO â†’ +0
  - Country != US? NO â†’ +0
  - Express? NO â†’ +0
  Score: 0
Decision: APPROVE âœ“
Stripe PaymentIntent: CREATED
```

### Example 2: Medium Risk â†’ CHALLENGE
```
Input: $100 purchase, US, express shipping
Scoring:
  - Amount > $50? YES â†’ +30
  - Country != US? NO â†’ +0
  - Express? YES â†’ +10
  Score: 40
Decision: CHALLENGE âš ï¸
Stripe PaymentIntent: NOT CREATED
```

### Example 3: High Risk â†’ BLOCK
```
Input: $100 purchase, Japan, express shipping
Scoring:
  - Amount > $50? YES â†’ +30
  - Country != US? YES â†’ +20
  - Express? YES â†’ +10
  Score: 60
Decision: BLOCK âœ—
Stripe PaymentIntent: NOT CREATED
```

---

## ğŸ“ Service Responsibilities

### PaymentController
- Entry point for all requests
- Orchestrates the pipeline
- Catches and logs errors
- Formats responses

### ACPParser
- Extracts fields from raw payload
- Performs basic field mapping
- Validates data types

### Normalizer
- Converts dollars to cents
- Standardizes field names
- Lowercase provider/shipping
- Creates internal format

### RiskEngine
- Applies scoring rules
- Calculates total risk score
- Applies decision logic
- Returns typed RiskResult

### StripeService
- Creates PaymentIntent in test mode
- Uses Stripe test API key
- Adds metadata for tracking
- Error handling & logging

### Validation Middleware
- Protocol validation
- Payload structure check
- Required field validation
- Returns 400 on failure

---

## ğŸ§ª Test Coverage

### Unit Tests
- **riskEngine**: 8 tests
  - Individual scoring factors
  - Score thresholds
  - Decision classification
  - Edge cases

- **normalizer**: 2 tests
  - Basic normalization
  - Missing field handling

### Integration Tests
- **paymentController**: 5 tests
  - APPROVE flow with Stripe
  - CHALLENGE flow
  - BLOCK flow
  - Protocol validation
  - Missing field validation

---

## ğŸš€ Deployment Checklist

- [ ] Set `NODE_ENV=production`
- [ ] Configure actual Stripe test key
- [ ] Set appropriate PORT
- [ ] Run tests: `npm test`
- [ ] Build: `npm run build` (if applicable)
- [ ] Start: `npm start`
- [ ] Test endpoints with real data
- [ ] Monitor logs for errors
- [ ] Set up error tracking (Sentry, etc.)

---

## ğŸ“ Error Handling

### Validation Errors (400)
```json
{
  "error": "Invalid protocol. Expected \"ACP\"."
}
```

### Missing Fields (400)
```json
{
  "error": "Missing required field: payment_provider"
}
```

### Stripe Errors (200, but logged)
- PaymentIntent creation failure is caught and logged
- Response still returns risk decision
- Payment processing gracefully fails

### Server Errors (500)
```json
{
  "error": "An error occurred while processing the payment."
}
```

---

**Architecture Complete! Ready for Production** âœ…
